@{
    ViewData["Title"] = "T·∫°o phi·∫øu xu·∫•t h√†ng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- N√∫t quay l·∫°i -->
<a href="@Url.Action("Index", "XuatHang")"
   style="display:inline-block; margin-bottom:15px; text-decoration:none; color:#007bff;">
   ‚¨Ö Quay l·∫°i danh s√°ch phi·∫øu xu·∫•t
</a>

<h2>T·∫°o phi·∫øu xu·∫•t h√†ng</h2>

<div style="display:flex; gap:20px; align-items:flex-start;">
    <!-- B√™n tr√°i -->
    <div style="flex:1; background:#fff; border:1px solid #ddd; border-radius:6px; padding:15px;">
        <div style="display:flex; align-items:center; gap:8px;">
            <input type="text" placeholder="T√¨m h√†ng h√≥a theo m√£ ho·∫∑c t√™n (F3)" 
                   style="flex:1; padding:8px; border-radius:4px; border:1px solid #ccc;" />
            <button id="btnAddProduct" type="button" style="background:#007bff; color:white; border:none; padding:8px 14px; border-radius:4px;">
                ‚ûï
            </button>
        </div>
        <br />

        <table border="1" style="width:100%; border-collapse:collapse;">
            <thead style="background:#f6f8fa;">
                <tr>
                    <th>STT</th>
                    <th>M√£ h√†ng</th>
                    <th>T√™n h√†ng</th>
                    <th>ƒêVT</th>
                    <th>T·ªìn kho</th>
                    <th>S·ªë l∆∞·ª£ng xu·∫•t</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>Th√†nh ti·ªÅn</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                <tr>
                    <td colspan="8" style="text-align:center; padding:40px;">
                        <strong>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</strong><br />
                        <small>Nh·∫•n n√∫t ‚ûï ƒë·ªÉ th√™m s·∫£n ph·∫©m ho·∫∑c ch·ªçn file d·ªØ li·ªáu</small><br /><br />

                        <!-- Input file ·∫©n -->
                        <input type="file" id="fileInput" style="display:none;" />

                        <!-- N√∫t gi·∫£ -->
                        <button type="button" 
                                style="background:#007bff; color:white; border:none; padding:8px 16px; border-radius:4px;"
                                onclick="document.getElementById('fileInput').click();">
                            üìÇ Ch·ªçn file d·ªØ li·ªáu
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- B√™n ph·∫£i -->
    <div style="width:350px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:15px;">
        <label>Kh√°ch h√†ng</label>
        <input type="text" placeholder="T√¨m kh√°ch h√†ng" class="form-control"
               style="width:100%; padding:8px; margin-bottom:10px;" />

        <label>M√£ phi·∫øu xu·∫•t</label>
        <input type="text" placeholder="M√£ phi·∫øu t·ª± ƒë·ªông" style="width:100%; padding:8px; margin-bottom:10px;" />

        <label>Tr·∫°ng th√°i</label>
        <input type="text" value="Phi·∫øu t·∫°m" readonly style="width:100%; padding:8px; margin-bottom:10px;" />

        <label>T·ªïng ti·ªÅn h√†ng</label>
        <input type="text" id="tongTienHang" value="0" readonly style="width:100%; padding:8px; margin-bottom:10px;" />

        <label>Gi·∫£m gi√°</label>
        <input type="number" id="giamGia" value="0" style="width:100%; padding:8px; margin-bottom:10px;" />

        <label>Kh√°ch ph·∫£i tr·∫£</label>
        <input type="text" id="canTra" value="0" readonly style="width:100%; padding:8px; color:#007bff; font-weight:bold; margin-bottom:10px;" />

        <label>Ghi ch√∫</label>
        <textarea rows="3" placeholder="Ghi ch√∫ xu·∫•t h√†ng" style="width:100%; padding:8px; margin-bottom:10px;"></textarea>

        <form method="post" action="/Phieu/Xuat/LuuTam">
            <div style="display:flex; justify-content:space-between;">
                <button type="submit" style="background:#007bff; color:white; border:none; padding:10px 20px; border-radius:4px;">
                    üíæ L∆∞u t·∫°m
                </button>
                <button type="submit" formaction="/Phieu/Xuat/HoanThanh" 
                        style="background:#28a745; color:white; border:none; padding:10px 20px; border-radius:4px;">
                    ‚úÖ Ho√†n th√†nh xu·∫•t
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal th√™m s·∫£n ph·∫©m -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addProductLabel">Th√™m s·∫£n ph·∫©m xu·∫•t</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">T√™n h√†ng</label>
          <input type="text" id="tenHang" class="form-control" placeholder="Nh·∫≠p t√™n h√†ng...">
        </div>
        <div class="mb-2">
          <label class="form-label">ƒê∆°n v·ªã t√≠nh</label>
          <input type="text" id="dvt" class="form-control" placeholder="VD: c√°i, h·ªôp...">
        </div>
        <div class="mb-2">
          <label class="form-label">T·ªìn kho</label>
          <input type="number" id="tonKho" class="form-control" value="50" readonly>
        </div>
        <div class="mb-2">
          <label class="form-label">S·ªë l∆∞·ª£ng xu·∫•t</label>
          <input type="number" id="soLuong" class="form-control" min="1" value="1">
        </div>
        <div class="mb-2">
          <label class="form-label">ƒê∆°n gi√°</label>
          <input type="number" id="donGia" class="form-control" min="0" value="0">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button type="button" class="btn btn-primary" id="btnSaveProduct">Th√™m</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const btnAdd = document.getElementById("btnAddProduct");
    const modal = new bootstrap.Modal(document.getElementById("addProductModal"));
    const tbody = document.getElementById("productTableBody");
    const tongTien = document.getElementById("tongTienHang");
    const giamGia = document.getElementById("giamGia");
    const canTra = document.getElementById("canTra");

    btnAdd.addEventListener("click", () => modal.show());

    document.getElementById("btnSaveProduct").addEventListener("click", () => {
        const ten = tenHang.value.trim();
        const dvtVal = dvt.value.trim();
        const ton = parseInt(tonKho.value);
        const sl = parseInt(soLuong.value);
        const gia = parseFloat(donGia.value);

        if (!ten || sl <= 0 || gia < 0) {
            alert("Vui l√≤ng nh·∫≠p th√¥ng tin h·ª£p l·ªá!");
            return;
        }

        const thanhTien = sl * gia;

        if (tbody.rows.length === 1 && tbody.rows[0].cells.length === 1)
            tbody.innerHTML = "";

        const newRow = `
            <tr>
                <td>${tbody.rows.length + 1}</td>
                <td>SP00${tbody.rows.length + 1}</td>
                <td>${ten}</td>
                <td>${dvtVal}</td>
                <td>${ton}</td>
                <td>${sl}</td>
                <td>${gia.toLocaleString()}</td>
                <td>${thanhTien.toLocaleString()}</td>
            </tr>`;
        tbody.insertAdjacentHTML("beforeend", newRow);

        // c·∫≠p nh·∫≠t t·ªïng ti·ªÅn
        let total = 0;
        tbody.querySelectorAll("tr").forEach(row => {
            const val = row.cells[7]?.textContent.replace(/,/g, "");
            if (!isNaN(val)) total += parseFloat(val);
        });
        tongTien.value = total.toLocaleString();
        canTra.value = (total - parseFloat(giamGia.value || 0)).toLocaleString();

        modal.hide();
    });

    giamGia.addEventListener("input", () => {
        const total = parseFloat(tongTien.value.replace(/,/g, "") || 0);
        const discount = parseFloat(giamGia.value || 0);
        canTra.value = (total - discount).toLocaleString();
    });
});
</script>
